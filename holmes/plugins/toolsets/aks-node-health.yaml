toolsets:
  aks/node-health:
    description: "Set of tools to troubleshoot AKS node health issues"
    tags:
      - cli
    prerequisites:
      - command: "az aks --help"
      - command: "kubectl version --client"

    tools:
      - name: "check_node_status"
        description: "Checks the status of all nodes in the AKS cluster."
        user_description: "get the status of all nodes in the AKS cluster"
        command: |
          kubectl get nodes

      - name: "describe_node"
        description: "Describes a specific node in the AKS cluster to inspect its conditions."
        user_description: "describe node {{ NODE_NAME }} in the AKS cluster"
        command: |
          kubectl describe node {{ NODE_NAME }}

      - name: "get_node_events"
        description: "Fetches recent events for a specific node to surface warnings and errors."
        user_description: "get events for node {{ NODE_NAME }}"
        command: |
          kubectl get events --field-selector involvedObject.kind=Node,involvedObject.name={{ NODE_NAME }} --sort-by='.lastTimestamp'

      - name: "check_node_resource_usage"
        description: "Shows CPU/memory usage for a specific node (requires metrics-server)."
        user_description: "get resource usage for node {{ NODE_NAME }}"
        command: |
          kubectl top node {{ NODE_NAME }}

      - name: "check_vmss_health"
        description: "Retrieves VMSS instance view to inspect health of a specific node VM instance."
        user_description: "check VMSS health for node {{ NODE_NAME }} in resource group {{ RESOURCE_GROUP_NAME }}"
        command: |
          az vmss get-instance-view --resource-group {{ RESOURCE_GROUP_NAME }} --name {{ VMSS_NAME }} --instance-id {{ NODE_INSTANCE_ID }}

      - name: "review_activity_log"
        description: "Reviews the Azure Activity Log for recent changes affecting the node."
        user_description: "review Azure Activity Log for resource group {{ RESOURCE_GROUP_NAME }}"
        command: |
          az monitor activity-log list --resource-group {{ RESOURCE_GROUP_NAME }}

      - name: "restart_node"
        description: "Restarts a specific VM instance in the AKS node pool VMSS."
        user_description: "restart node {{ NODE_NAME }} in the AKS cluster"
        command: |
          az vmss restart --resource-group {{ RESOURCE_GROUP_NAME }} --name {{ VMSS_NAME }} --instance-ids {{ NODE_INSTANCE_ID }}

      - name: "reimage_node"
        description: "Reimages a specific VM instance in the AKS node pool VMSS."
        user_description: "reimage node {{ NODE_NAME }} in the AKS cluster"
        command: |
          az vmss reimage --resource-group {{ RESOURCE_GROUP_NAME }} --name {{ VMSS_NAME }} --instance-ids {{ NODE_INSTANCE_ID }}
